<!-- 
 Student View Page 
 Displays a table with all students and relevant fields 
 Allows sorting by each field 
 --> 
{% extends 'base.html' %}
{% load query_tags %}

{% block styles %}
<style> 
table {
    border-collapse: collapse;
    width: 100%;
    max-width: 800px;
    margin: 20px auto; 
    font-family: Arial, sans-serif; 
}
th, td {
    border: 1px solid #ddd; 
    padding: 8px 12px; 
    text-align: left; 
}
th {
    background-color: #667eea; 
    color: white; 
}
tr:nth-child(even) {
    background-color: f4f4f4;
}
tr:hover {
    background-color: c7cdfd;
}
</style> 
{% endblock styles %}

{% block content %}
<h1 style="text-align:center;">Student List</h1>

<!-- Filter Bar for admin to select from -->
<form method="get"> 
    <label for="cwa_min">CWA Min:</label> 
    <input 
        type="number"
        id="cwa_min"
        name="cwa_min" 
        step="1"
        min="0"
        max="100"
        value="{{ request.GET.cwa_min|default_if_none:'0' }}"  
    />

    <label for="cwa_max">CWA Max:</label>
    <input
        type="number"
        id="cwa_max"
        name="cwa_max"
        step="1"
        min="0"
        max="100"
        value="{{ request.GET.cwa_max|default_if_none:'100' }}"
    />

    <!-- Display error message for CWA if invalid values -->
    <div id="cwa_error" style="color:red; margin-top:5px; display:none;"></div>
    <br><br>

    <!-- 
    Degree-Major CheckBox
    - Allows for selection of multiple majors for filtering the view
    -->
    <fieldset> 
        <legend>Degree & Major</legend>
        {% for degree, majors in degree_major_pairs.items %}
            <strong>{{ degree }}</strong><br>
            {% for major in majors %}
                <label> 
                    <input type="checkbox" name="degree_major" value="{{ degree }}||{{ major }}"
                        {% if degree|add:"||"|add:major in selected_pairs %}
                            checked 
                        {% endif %}
                    >
                    {{ major }}
                </label><br>
            {% endfor %}
            <br>
        {% endfor %}
    </fieldset>

    <!-- Degree-Major dropdown - ->
    <label for="degree_major">Degree & Major:</label> 
    <select id="degree_major" name="degree_major" multiple size="8"> <!-- Enable multiple options to be selected - ->
        <option disabled>-- Select Degree & Major --</option>
        {% for degree, majors in degree_major_pairs.items %}
            <optgroup label="{{ degree }}">
                {% for major in majors %}
                    <option value="{{ degree }}||{{ major }}"
                        {% if degree|add:"||"|add:major in selected_pairs %}
                            selected
                        {% endif %}
                    >
                        {{ major }}
                    </option>
                {% endfor %}
            </optgroup>
            {% endfor %}
    </select>
    -->
    <br><br>

    <label for="application_submitted">Application Submitted</label>
    <select id="application_submitted" name="application_submitted">
        <option value="">-- Any --</option>
        <option value="yes" {% if application_submitted == 'yes' %}selected{% endif %}>Yes</option>
        <option value="no" {% if application_submitted == 'no' %}selected{% endif %}>No</option>
    </select>
    <br><br>

    <!-- Checkbox to show students who are already in a group -->
    <label> 
        Show students already allocated to a group 
        <input type="checkbox" name="show_allocated" value="true" {% if show_allocated == 'true' %}checked{% endif %}>
    </label>
    <br><br>

    <!-- Submit filters button -->
    <button type="submit">Filter</button>

    <!-- Reset button that clears all filters -->
    <button
        type="button"
        id="reset-btn"
        data-url="{% url 'student_view' %}"
        >
        Reset
    </button>
    <!-- Goes to the same page without any GET parameters -->
</form>

<table> 
    <thead> 
        <tr> 
            <th>Student ID</th>
            <th>Name</th>
            <!-- CWA column with two arrow links (ascending or descending )-->
            <th>
                CWA 
                <!-- ascending -->
                <a href="?{% update_query sort='cwa_asc' %}" title="Sort CWA ascending" style="margin-left: 8px; text-decoration:none;">▲</a>
                <!-- descending -->
                <a href="?{% update_query sort='cwa_desc' %}" title="Sort CWA descending" style="margin-left: 4px; text-decoration:none;">▼</a>
            </th>
            <th>
                Course
                <a href="?{% update_query sort='major_asc' %}" title="Group by Major" style="margin-left: 4px; text-decoration:none;">▼</a>
            </th>
        </tr>
    </thead>
    <tbody> 
        {% for student in students %}
            <tr>
                <!-- Retrieving information from models -->
                <td>{{ student.student_id }}</td>
                <td>{{ student.name }}</td>
                <td>{% if student.cwa %}{{ student.cwa }}{% else %}N/A{% endif %}</td>
                <td>{{ student.major }} ({{ student.degree }})</td> <!-- Displays combined Major, Degree -->
            </tr>
        {% empty %}
            <tr>
                <td colspan="5" style="text-align:center;">No students found.</td>
            </tr>
        {% endfor %}
    </tbody>
</table>

<!-- JS for the button function -->
<script>
  document.getElementById('reset-btn').addEventListener('click', function() {
    window.location.href = this.dataset.url;
  });
</script>

<!-- 
Validation for the CWA inputs
- Enforce min < max
- Enforce max > min 
- Should be between 0 & 100  
-->
<script> 
const cwaMinInput = document.getElementById('cwa_min');
const cwaMaxInput = document.getElementById('cwa_max');
const cwaErrorDiv = document.getElementById('cwa_error');
const form = cwaMinInput.closest('form'); //find parent form
const submitButton = form.querySelector('button[type="submit"]'); //find submit button

function validateCWA()
{
    let min = parseFloat(cwaMinInput.value);
    let max = parseFloat(cwaMaxInput.value);

    //Enforce min & max >= 0
    if (!isNaN(min) && min < 0)
    {
        min = 0;
        cwaMinInput.value = min;
    }
    if (!isNaN(max) && max < 0)
    {
        max = 0;
        cwaMaxInput.value = max;
    }

    //Enforce min & max <= 100
    if (!isNaN(max) && max > 100)
    {
        max = 100;
        cwaMaxInput.value = max;
    }
    if (!isNaN(min) && min > 100)
    {
        min = 100;
        cwaMinInput.value = min;
    }

    //Check min <= max
    if (!isNaN(min) && !isNaN(max) && min > max)
    {
        cwaErrorDiv.textContent = 'CWA Min cannot be greater than CWA Max.'; //display error
        cwaErrorDiv.style.display = 'block';
        submitButton.disabled = true; //disable submit button while invalid inputs 
    }
    else 
    {
        cwaErrorDiv.textContent = ''; //clear error
        cwaErrorDiv.style.display = 'none';
        submitButton.disabled = false;
    }
}
//Run validation on input changes
cwaMinInput.addEventListener('input', validateCWA);
cwaMaxInput.addEventListener('input', validateCWA);

//Validate when page loads
validateCWA()
</script> 

{% endblock content %}