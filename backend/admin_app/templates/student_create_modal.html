<!-- 
 Modal Container for student creation
 - Hidden by default, pops up when option is triggered
 -->
 <div id="studentModal" class="modal" style="display:none">
    <div class="modal-content">
        <span class="close-btn">&times;</span> <!-- Close -->
        <h2>Add Student</h2>

        <!-- Form posts to view -->
        <form id="createStudentForm" method="post" action="{% url 'admin_student_create' %}" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }} <!-- Render fields -->
            <button type="submit">Save</button>
        </form>

        <!-- Validation Errors display -->
        <div id="formErrors" style="color:red"></div>
     </div>
 </div>

 <!-- JS for open/close modal logic -->
<script> 
(function () {
    // Get form element inside modal
    const form = document.getElementById('createStudentForm');
    const modal = document.getElementById('studentModal')
    const closeBtn = modal.querySelector('.close-btn')
    const modalSubmit = form.querySelector('button[type="submit"]');

    function openModal() {
        //modal.style.display = 'block'; 
        modalSubmit.disabled = true;
        modal.style.display = 'flex';
    }
    closeBtn.onclick = () => modal.style.display = 'none'; //Hide if close button is clicked
    window.onclick = (e) => {
        if (e.target == modal) modal.style.display = 'none'; //Hide if click outside of it 
    }

    // Client side validation for required fields 
    // If user leaves field empty and clicks away, shows red message under that field 
    function addImmediateValidation(input, options = {})
    {
        const errorSpan = document.createElement('div');
        errorSpan.style.color = 'red';
        input.insertAdjacentElement('afterend', errorSpan)

        const validate = () => {
            const value = input.value.trim();
            let valid = true;

            //Required  field check
            if (value === '') {
                errorSpan.textContent = `${input.name.replace('_', ' ')} is required.`;
                valid = false;
            }

            //Custom check (enforce 8 digits for studentID)
            if (options.customCheck && !options.customCheck(value))
            {
                errorSpan.textContent = options.customMessage || 'Invalid Value.';
                valid = false;
            }

            //Clear error message if everything is fine 
            if (valid) {
                errorSpan.textContent = '';
            }

            //Disable the Save button if all fields aren't valid 
            modalSubmit.disabled = !allFieldsValid()

            return valid;
        }

        input.addEventListener('blur', validate);
        input.addEventListener('input', validate);
    }

    //Checks to see if input fields are valid
    function allFieldsValid()
    {
        //List of required inputs
        const requiredFields = [idField, nameField];

        //Return true only when every field is non-emtpy and there are no error messages
        return requiredFields.every(input => {
            const valueFilled = input.value.trim() !== '';
            const noError = !input.nextElementSibling.textContent;
            return valueFilled && noError;
        })
    }

    //Enable validation
    const idField = form.querySelector('input[name="student_id"]');
    const nameField = form.querySelector('input[name="name"]');

    if (idField) 
    {
        addImmediateValidation(idField, {
            customCheck: value =>/^\d{8}$/.test(value), //must be exactly 8 digits
            customMessage: 'Student ID must be exactly 8 digits.'
        });
    }

    if (nameField) addImmediateValidation(nameField)

    const cwaInput = document.getElementById('cwa');
    const cwaErrorDiv = document.getElementById('cwa_error');

    function validateCWA()
    {
        let value = parseFloat(cwaInput.value);

        //Enforce 0-100
        if (!isNaN(value) && value < 0) {
            value = 0;
            cwaInput.value = value;
        }
        if (!isNaN(value) && value > 100) {
            value = 100;
            cwaInput.value = value;
        }
    }

    cwaInput.addEventListener('input', validateCWA);
    validateCWA();

    //Event Listener
    form.addEventListener('submit', function(e) 
    {
        e.preventDefault(); //Prevent default full-page form submission
        
        const formData = new FormData(form);
        fetch(form.action, { //Send form using Fetch API
            method: 'POST', 
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) 
            {
                //Form submitted successfully 
                alert('Student added successfully!');
                modal.style.display = 'none'; //close modal
            }
            else 
            {
                //Validation Failed
                const errorsDiv = document.getElementById('formErrors');
                errorsDiv.innerHTML = ''; //clear previous errors

                //Loop through each error and display:
                for (const field in data.errors)
                {
                    errorsDiv.innerHTML += `${field}: ${data.errors[field].join(', ')}<br>`; 
                }
            }
        })
        .catch(err => console.error(err)); //Log unexpected errors
    })

    //Disable "Save" button if there is an error 
})();
</script> 