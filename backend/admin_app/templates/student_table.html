<!--
- Contains code for a pop-up, scrollable student view.
-->

<!-- Filter Bar for admin to select from -->
<form method="get"> 
    <label for="cwa_min">CWA Min:</label> 
    <input 
        type="number"
        id="cwa_min"
        name="cwa_min" 
        step="1"
        min="0"
        max="100"
        value="{{ request.GET.cwa_min|default_if_none:'0' }}"  
    />
    <label for="cwa_max">CWA Max:</label>
    <input
        type="number"
        id="cwa_max"
        name="cwa_max"
        step="1"
        min="0"
        max="100"
        value="{{ request.GET.cwa_max|default_if_none:'100' }}"
    />

    <!-- Display error message for CWA if invalid values -->
    <div id="cwa_error" style="color:red; margin-top:5px; display:none;"></div>
    <br><br>

    <!-- 
    Degree-Major CheckBox
    - Allows for selection of multiple majors for filtering the view
    -->
    <fieldset> 
        <legend>Degree & Major</legend>
        {% for degree, majors in degree_major_pairs.items %}
            <strong>{{ degree }}</strong><br>
            {% for major in majors %}
                <label> 
                    <input type="checkbox" name="degree_major" value="{{ degree }}||{{ major }}"
                        {% if degree|add:"||"|add:major in selected_pairs %}
                            checked 
                        {% endif %}
                    >
                    {{ major }}
                </label><br>
            {% endfor %}
            <br>
        {% endfor %}
    </fieldset>
    <br><br>

    <label for="application_submitted">Application Submitted</label>
    <select id="application_submitted" name="application_submitted">
        <option value="">-- Any --</option>
        <option value="yes" {% if application_submitted == 'yes' %}selected{% endif %}>Yes</option>
        <option value="no" {% if application_submitted == 'no' %}selected{% endif %}>No</option>
    </select>
    <br><br>

    <!-- Dropdown to show students who are allocated a group, or not -->
    <label for="group_status">Group Status:</label>
    <select name="group_status" id="group_status">
        <option value="all" {% if group_status == 'all' or not group_status %}selected{% endif %}>All Students</option> <!-- Default -->
        <option value="assigned" {% if group_status == 'assigned' %}selected{% endif %}>Assigned Students Only</option>
        <option value="unassigned" {% if group_status == 'unassigned' %}selected{% endif %}>Unassigned Students Only</option>
    </select>
    <br><br>

    <!-- 
    Submit filters button 
    Goes to the same page without any GET parameters
    -->
    <button type="submit">Filter</button>

    <!-- Reset button that clears all filters -->
    <button
        type="button"
        id="reset-btn"
        data-url="{% url 'admin_dashboard:student_view' %}"
        >
        Reset
    </button>

    <br><br>
    <button
        type="button"
        onclick="openModal()"
        style="margin: 10px 0;">+ Add Student
    </button> 

    <br>
    <button 
        type="button"
        onclick="openImportModal()"
        style="margin:10px 0;">Import Students</button>
    </button>
</form>

<div class="scroll-container">
    <table> 
        <thead> 
            <tr> 
                <th>Student ID</th>
                <th>Notes</th>
                <th>Name</th>
                <th>Group</th>
                <!-- CWA column with two arrow links (ascending or descending )-->
                <th>
                    CWA 
                    <!-- ascending -->
                    <a href="?{% update_query sort='cwa_asc' %}" title="Sort CWA ascending" style="margin-left: 8px; text-decoration:none;">▲</a>
                    <!-- descending -->
                    <a href="?{% update_query sort='cwa_desc' %}" title="Sort CWA descending" style="margin-left: 4px; text-decoration:none;">▼</a>
                </th>
                <th>
                    Course
                    <a href="?{% update_query sort='major_asc' %}" title="Group by Major" style="margin-left: 4px; text-decoration:none;">▼</a>
                </th>
            </tr>
        </thead>
        <tbody> 
            {% for student in students %}
                <tr>
                    <!-- Retrieving information from models -->
                    <td>{{ student.student_id }}</td>

                    <td>
                        <!-- Add a button to view & edit student notes -->
                        <button 
                            class="notes-btn {% if student.notes %}btn-success{% else %}btn-secondary{% endif %}"
                            data-student-id="{{ student.student_id }}"
                            data-student-notes="{{ student.notes|default:'' }}"
                            onclick="openNotesModal(this)"
                        >
                        Notes
                    </button>
                    </td>

                    <td>{{ student.name }}</td>

                    <td> 
                        {% if student.final_group_member %}
                            {{ student.final_group_member.final_group.finalgroup_id }}
                        {% else %}
                            <span style="color: gray;">--</span>
                        {% endif %}
                    </td>

                    <td>{% if student.cwa is not None %}{{ student.cwa }}
                        {% else %}
                            <span style="color: grey;">--</span>
                        {% endif %}
                    </td>

                    <td>{% if student.major %}{{ student.major }}
                        {% else %}
                            <span style="color: grey;">--</span>
                        {% endif %}
                    </td> <!-- Displays combined Major, Degree -->

                </tr>
            {% empty %}
            <tr>
                <td colspan="5" style="text-align:center;">No students found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>